<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Filter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #1a1f26;
      color: #e7e9ea;
      width: 210px;
      min-height: 100vh;
      overflow: hidden;
      user-select: none;
    }
    .header {
      background: linear-gradient(135deg, #1d9bf0 0%, #7856ff 100%);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
      -webkit-app-region: drag;
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .logo { font-size: 20px; }
    .title { font-size: 14px; font-weight: 600; }
    .header-btns { display: flex; gap: 6px; -webkit-app-region: no-drag; }
    .header-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header-btn:hover { background: rgba(255,255,255,0.3); }
    .close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      -webkit-app-region: no-drag;
    }
    .close-btn:hover { background: rgba(255,255,255,0.3); }
    .content { padding: 16px; }
    .status-ring {
      width: 100px;
      height: 100px;
      margin: 0 auto 12px;
      position: relative;
    }
    .ring-bg {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 5px solid #2f3336;
    }
    .ring-progress {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 5px solid transparent;
      border-top-color: #71767b;
      transform: rotate(-90deg);
      transition: all 0.3s;
    }
    .ring-progress.authorized { border-color: #00ba7c; }
    .ring-progress.unauthorized { border-top-color: #f4212e; }
    .ring-progress.pending { border-top-color: #ffd400; animation: spin 2s linear infinite; }
    @keyframes spin { 100% { transform: rotate(270deg); } }
    .ring-content {
      position: absolute;
      inset: 8px;
      border-radius: 50%;
      background: #1c1f23;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .ring-icon { font-size: 24px; }
    .ring-percent { font-size: 18px; font-weight: 700; }
    .status-text { text-align: center; margin-bottom: 16px; }
    .status-label { font-size: 13px; font-weight: 600; }
    .status-label.authorized { color: #00ba7c; }
    .status-label.unauthorized { color: #f4212e; }
    .status-label.pending { color: #ffd400; }
    .status-label.inactive { color: #71767b; }
    .status-sub { font-size: 11px; color: #71767b; margin-top: 2px; }
    .meters { display: flex; gap: 12px; margin-bottom: 16px; }
    .meter { flex: 1; background: #16181c; border-radius: 8px; padding: 10px; }
    .meter-label { font-size: 9px; color: #71767b; text-transform: uppercase; margin-bottom: 4px; }
    .meter-bar-bg { height: 4px; background: #2f3336; border-radius: 2px; overflow: hidden; }
    .meter-bar { height: 100%; width: 0%; border-radius: 2px; transition: width 0.05s; }
    .meter-bar.vol { background: linear-gradient(90deg, #00ba7c, #1d9bf0); }
    .meter-bar.vad { background: linear-gradient(90deg, #7856ff, #f91880); }
    .meter-value { font-size: 10px; text-align: right; margin-top: 2px; }
    .main-btn {
      width: 100%;
      padding: 14px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }
    .main-btn.start { background: #00ba7c; color: white; }
    .main-btn.start:hover { background: #00a36c; }
    .main-btn.stop { background: #f4212e; color: white; }
    .main-btn.stop:hover { background: #dc1e28; }
    .main-btn:disabled { background: #38444d; color: #71767b; cursor: not-allowed; }
    .quick-btns { display: flex; gap: 8px; }
    .quick-btn {
      flex: 1;
      background: #16181c;
      border: 1px solid #2f3336;
      border-radius: 8px;
      padding: 10px 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .quick-btn:hover { background: #1f2328; border-color: #3b4148; }
    .quick-btn-icon { font-size: 16px; margin-bottom: 4px; }
    .quick-btn-label { font-size: 9px; color: #71767b; }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2f3336;
    }
    .stat { text-align: center; }
    .stat-value { font-size: 16px; font-weight: 700; }
    .stat-label { font-size: 9px; color: #71767b; }
    .no-profile {
      text-align: center;
      padding: 20px;
    }
    .no-profile-icon { font-size: 40px; margin-bottom: 12px; }
    .no-profile-text { font-size: 13px; color: #71767b; margin-bottom: 16px; }
    .enroll-btn {
      background: #1d9bf0;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .enroll-btn:hover { background: #1a8cd8; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="logo">üéôÔ∏è</span>
      <span class="title">Voice Filter</span>
    </div>
    <div class="header-btns">
      <a href="http://localhost:47823/" class="header-btn" title="Back to Home">üè†</a>
      <button class="close-btn" id="close-btn">‚úï</button>
    </div>
  </div>

  <div class="content" id="main-view">
    <div class="status-ring">
      <div class="ring-bg"></div>
      <div class="ring-progress" id="ring"></div>
      <div class="ring-content">
        <span class="ring-icon" id="ring-icon">üîá</span>
        <span class="ring-percent" id="ring-percent">--</span>
      </div>
    </div>

    <div class="status-text">
      <div class="status-label inactive" id="status-label">Inactive</div>
      <div class="status-sub" id="status-sub">Click Start to begin filtering</div>
    </div>

    <div class="meters">
      <div class="meter">
        <div class="meter-label">Volume</div>
        <div class="meter-bar-bg"><div class="meter-bar vol" id="vol-bar"></div></div>
        <div class="meter-value" id="vol-val">0%</div>
      </div>
      <div class="meter">
        <div class="meter-label">Speech</div>
        <div class="meter-bar-bg"><div class="meter-bar vad" id="vad-bar"></div></div>
        <div class="meter-value" id="vad-val">0%</div>
      </div>
    </div>

    <button class="main-btn start" id="main-btn">Start Filter</button>

    <div class="quick-btns">
      <div class="quick-btn" id="btn-meeting">
        <div class="quick-btn-icon">üéôÔ∏è</div>
        <div class="quick-btn-label">Meeting</div>
      </div>
      <div class="quick-btn" id="btn-enroll">
        <div class="quick-btn-icon">üîÑ</div>
        <div class="quick-btn-label">Re-enroll</div>
      </div>
      <div class="quick-btn" id="btn-dashboard">
        <div class="quick-btn-icon">üìä</div>
        <div class="quick-btn-label">Dashboard</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="stat-checks">0</div>
        <div class="stat-label">Checks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-blocks">0</div>
        <div class="stat-label">Blocks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-time">--</div>
        <div class="stat-label">Last</div>
      </div>
    </div>
  </div>

  <div class="content hidden" id="no-profile-view">
    <div class="no-profile">
      <div class="no-profile-icon">üé§</div>
      <div class="no-profile-text">No voice profile found.<br>Enroll your voice to use the filter.</div>
      <button class="enroll-btn" id="btn-enroll-new">Enroll Voice</button>
    </div>
  </div>

  <script>
    var ws = new WebSocket("ws://" + window.location.host);
    var mainView = document.getElementById("main-view");
    var noProfileView = document.getElementById("no-profile-view");
    var ring = document.getElementById("ring");
    var ringIcon = document.getElementById("ring-icon");
    var ringPercent = document.getElementById("ring-percent");
    var statusLabel = document.getElementById("status-label");
    var statusSub = document.getElementById("status-sub");
    var volBar = document.getElementById("vol-bar");
    var volVal = document.getElementById("vol-val");
    var vadBar = document.getElementById("vad-bar");
    var vadVal = document.getElementById("vad-val");
    var mainBtn = document.getElementById("main-btn");
    var statChecks = document.getElementById("stat-checks");
    var statBlocks = document.getElementById("stat-blocks");
    var statTime = document.getElementById("stat-time");

    var isActive = false;
    var hasProfile = false;
    var checks = 0;
    var blocks = 0;

    function send(type, data) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: type, data: data || {} }));
      }
    }

    function updateStatus(state, confidence) {
      ring.classList.remove("authorized", "unauthorized", "pending");
      statusLabel.classList.remove("authorized", "unauthorized", "pending", "inactive");
      var pct = Math.round(confidence * 100);
      ringPercent.textContent = pct + "%";
      if (state === "authorized") {
        ring.classList.add("authorized");
        statusLabel.classList.add("authorized");
        ringIcon.textContent = "üîì";
        statusLabel.textContent = "Authorized";
        statusSub.textContent = "Voice verified - audio passing";
      } else if (state === "unauthorized") {
        ring.classList.add("unauthorized");
        statusLabel.classList.add("unauthorized");
        ringIcon.textContent = "üîí";
        statusLabel.textContent = "Blocked";
        statusSub.textContent = "Unauthorized - audio muted";
      } else {
        ring.classList.add("pending");
        statusLabel.classList.add("pending");
        ringIcon.textContent = "üîÑ";
        statusLabel.textContent = "Verifying";
        statusSub.textContent = "Analyzing voice...";
      }
    }

    function setInactive() {
      ring.classList.remove("authorized", "unauthorized", "pending");
      statusLabel.classList.remove("authorized", "unauthorized", "pending");
      statusLabel.classList.add("inactive");
      ringIcon.textContent = "üîá";
      ringPercent.textContent = "--";
      statusLabel.textContent = "Inactive";
      statusSub.textContent = "Click Start to begin filtering";
      mainBtn.textContent = "Start Filter";
      mainBtn.classList.remove("stop");
      mainBtn.classList.add("start");
      isActive = false;
    }

    ws.onopen = function() {
      send("ready");
    };

    ws.onmessage = function(e) {
      var msg = JSON.parse(e.data);
      var type = msg.type;
      var data = msg.data;

      if (type === "has-profile") {
        hasProfile = true;
        mainView.classList.remove("hidden");
        noProfileView.classList.add("hidden");
      } else if (type === "volume-level") {
        var pct = Math.round(data * 100);
        volBar.style.width = pct + "%";
        volVal.textContent = pct + "%";
      } else if (type === "vad-level") {
        var vadPct = Math.round(data * 100);
        vadBar.style.width = vadPct + "%";
        vadVal.textContent = vadPct + "%";
      } else if (type === "filter-started") {
        isActive = true;
        mainBtn.textContent = "Stop Filter";
        mainBtn.classList.remove("start");
        mainBtn.classList.add("stop");
        updateStatus("pending", 0);
      } else if (type === "filter-stopped") {
        setInactive();
      } else if (type === "filter-verification") {
        checks++;
        statChecks.textContent = checks;
        statTime.textContent = new Date().toLocaleTimeString().slice(0, 5);
        updateStatus(data.decision, data.confidence);
        if (data.decision === "unauthorized") {
          blocks++;
          statBlocks.textContent = blocks;
        }
      } else if (type === "filter-muted") {
        updateStatus("unauthorized", 0);
      } else if (type === "filter-unmuted") {
        updateStatus("authorized", 1);
      } else if (type === "enrollment-complete") {
        hasProfile = true;
        mainView.classList.remove("hidden");
        noProfileView.classList.add("hidden");
      }
    };

    ws.onclose = function() {
      setInactive();
      statusSub.textContent = "Disconnected - restart app";
    };

    mainBtn.onclick = function() {
      if (isActive) {
        send("stop-filter");
      } else {
        send("start-filter");
      }
    };

    document.getElementById("close-btn").onclick = function() {
      send("close-window");
      window.close();
    };

    document.getElementById("btn-meeting").onclick = function() {
      window.open("http://localhost:47823/meeting", "_blank", "width=1000,height=700");
    };

    document.getElementById("btn-enroll").onclick = function() {
      window.open("http://localhost:47823/filter", "_blank", "width=1100,height=800");
    };

    document.getElementById("btn-dashboard").onclick = function() {
      window.open("http://localhost:47823", "_blank", "width=1100,height=800");
    };

    document.getElementById("btn-enroll-new").onclick = function() {
      window.open("http://localhost:47823/filter", "_blank", "width=1100,height=800");
    };

    if (!hasProfile) {
      send("ready");
    }

    // Resize window to fit content
    window.onload = function() {
      var width = 280;
      var height = document.body.scrollHeight + 40;
      if (window.outerWidth !== width || window.outerHeight !== height) {
        window.resizeTo(width, height);
      }
    };
  </script>
</body>
</html>
