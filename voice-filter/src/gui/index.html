<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annix Voice Filter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: #0f1419; color: #e7e9ea; min-height: 100vh; display: flex; flex-direction: column; }
    .header { background: linear-gradient(135deg, #1a1f26 0%, #141a21 100%); border-bottom: 1px solid #2f3336; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #1d9bf0 0%, #7856ff 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .logo-text { font-size: 18px; font-weight: 600; }
    .header-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #71767b; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #71767b; }
    .status-indicator.active { background: #00ba7c; box-shadow: 0 0 8px #00ba7c; animation: pulse 2s infinite; }
    .status-indicator.warning { background: #ffd400; }
    .status-indicator.error { background: #f4212e; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .main-container { flex: 1; display: flex; max-width: 1100px; width: 100%; margin: 0 auto; padding: 24px; gap: 24px; }
    .left-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .right-panel { width: 300px; display: flex; flex-direction: column; gap: 20px; }
    .card { background: #16181c; border: 1px solid #2f3336; border-radius: 16px; overflow: hidden; }
    .card-header { padding: 14px 18px; border-bottom: 1px solid #2f3336; display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-size: 14px; font-weight: 600; }
    .card-body { padding: 18px; }
    .verification-panel { text-align: center; padding: 28px 18px; }
    .verification-ring { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
    .ring-bg { position: absolute; inset: 0; border-radius: 50%; border: 6px solid #2f3336; }
    .ring-progress { position: absolute; inset: 0; border-radius: 50%; border: 6px solid transparent; border-top-color: #71767b; transform: rotate(-90deg); transition: all 0.3s; }
    .ring-progress.authorized { border-color: #00ba7c; }
    .ring-progress.unauthorized { border-top-color: #f4212e; }
    .ring-progress.pending { border-top-color: #ffd400; animation: spin 2s linear infinite; }
    @keyframes spin { 100% { transform: rotate(270deg); } }
    .ring-content { position: absolute; inset: 12px; border-radius: 50%; background: #1c1f23; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .ring-icon { font-size: 32px; margin-bottom: 2px; }
    .ring-percentage { font-size: 24px; font-weight: 700; }
    .ring-label { font-size: 11px; color: #71767b; text-transform: uppercase; }
    .verification-status { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
    .verification-status.authorized { color: #00ba7c; }
    .verification-status.unauthorized { color: #f4212e; }
    .verification-status.pending { color: #ffd400; }
    .verification-subtitle { font-size: 12px; color: #71767b; }
    .audio-meters { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .meter { background: #1c1f23; border-radius: 8px; padding: 12px; }
    .meter-label { font-size: 10px; color: #71767b; text-transform: uppercase; margin-bottom: 6px; }
    .meter-bar-container { height: 6px; background: #2f3336; border-radius: 3px; overflow: hidden; }
    .meter-bar { height: 100%; width: 0%; border-radius: 3px; transition: width 0.05s; }
    .meter-bar.volume { background: linear-gradient(90deg, #00ba7c, #1d9bf0); }
    .meter-bar.vad { background: linear-gradient(90deg, #7856ff, #f91880); }
    .meter-value { font-size: 11px; margin-top: 4px; text-align: right; }
    .btn { padding: 12px 18px; font-size: 14px; font-weight: 600; border: none; border-radius: 9999px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: #1d9bf0; color: #fff; width: 100%; }
    .btn-primary:hover { background: #1a8cd8; }
    .btn-primary.active { background: #f4212e; }
    .btn-primary:disabled { background: #38444d; color: #71767b; cursor: not-allowed; }
    .btn-secondary { background: transparent; color: #e7e9ea; border: 1px solid #536471; width: 100%; }
    .btn-secondary:hover { background: rgba(239, 243, 244, 0.1); }
    .quick-actions { display: flex; gap: 10px; margin-top: 14px; }
    .quick-action { flex: 1; background: #1c1f23; border: 1px solid #2f3336; border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .quick-action:hover { background: #1f2328; border-color: #3b4148; }
    .quick-action-icon { font-size: 20px; margin-bottom: 6px; }
    .quick-action-label { font-size: 11px; color: #71767b; }
    .device-selector { margin-bottom: 14px; }
    .device-label { font-size: 11px; color: #71767b; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .device-select { width: 100%; padding: 10px; background: #1c1f23; border: 1px solid #2f3336; border-radius: 8px; color: #e7e9ea; font-size: 12px; cursor: pointer; }
    .device-select:focus { outline: none; border-color: #1d9bf0; }
    .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #2f3336; }
    .setting-row:last-child { border-bottom: none; }
    .setting-info { flex: 1; }
    .setting-label { font-size: 13px; margin-bottom: 2px; }
    .setting-description { font-size: 11px; color: #71767b; }
    .slider { width: 100px; height: 4px; border-radius: 2px; background: #2f3336; appearance: none; cursor: pointer; }
    .slider::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #1d9bf0; cursor: pointer; }
    .slider-value { font-size: 12px; min-width: 32px; text-align: right; }
    .toggle { position: relative; width: 40px; height: 22px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #38444d; border-radius: 22px; transition: 0.2s; }
    .toggle-slider::before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #e7e9ea; border-radius: 50%; transition: 0.2s; }
    .toggle input:checked + .toggle-slider { background: #1d9bf0; }
    .toggle input:checked + .toggle-slider::before { transform: translateX(18px); }
    .session-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 11px; }
    .session-label { color: #71767b; }
    .session-value { font-family: monospace; }
    .hidden { display: none !important; }
    .setup-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px; }
    .setup-card { background: #16181c; border: 1px solid #2f3336; border-radius: 20px; padding: 36px; max-width: 440px; width: 100%; text-align: center; }
    .setup-steps { display: flex; justify-content: center; gap: 8px; margin-bottom: 28px; }
    .setup-step { width: 8px; height: 8px; border-radius: 50%; background: #2f3336; transition: all 0.3s; }
    .setup-step.active { background: #1d9bf0; width: 20px; border-radius: 4px; }
    .setup-step.completed { background: #00ba7c; }
    .setup-icon { width: 72px; height: 72px; background: linear-gradient(135deg, rgba(29, 155, 240, 0.15), rgba(120, 86, 255, 0.15)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 32px; }
    .setup-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
    .setup-description { font-size: 13px; color: #71767b; line-height: 1.5; margin-bottom: 28px; }
    .mic-test-visual { height: 56px; background: #1c1f23; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 3px; padding: 0 16px; }
    .mic-bar { width: 4px; height: 8px; background: #2f3336; border-radius: 2px; transition: height 0.1s, background 0.2s; }
    .mic-bar.active { background: linear-gradient(180deg, #1d9bf0, #00ba7c); }
    .device-badge { display: inline-flex; align-items: center; gap: 8px; background: #1c1f23; border-radius: 8px; padding: 10px 14px; margin-bottom: 20px; font-size: 12px; }
    .progress-ring-container { position: relative; width: 140px; height: 140px; margin: 0 auto 20px; }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: #2f3336; stroke-width: 6; }
    .progress-ring-fg { fill: none; stroke: #1d9bf0; stroke-width: 6; stroke-linecap: round; stroke-dasharray: 377; stroke-dashoffset: 377; transition: stroke-dashoffset 0.3s; }
    .progress-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .progress-percent { font-size: 28px; font-weight: 700; }
    .progress-label { font-size: 11px; color: #71767b; }
    .success-icon { width: 72px; height: 72px; background: linear-gradient(135deg, #00ba7c, #00d084); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 32px; }
    .error-box { background: rgba(244, 33, 46, 0.1); border: 1px solid rgba(244, 33, 46, 0.3); border-radius: 10px; padding: 14px; margin-bottom: 20px; text-align: left; }
    .error-title { font-size: 13px; font-weight: 600; color: #f4212e; margin-bottom: 4px; }
    .error-message { font-size: 12px; color: #ff6b78; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <div class="logo-icon">üéôÔ∏è</div>
        <span class="logo-text">Voice Filter</span>
      </a>
    </div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <button id="btn-meeting-mode" style="background: linear-gradient(135deg, rgba(120, 86, 255, 0.3), rgba(249, 24, 128, 0.3)); border: 1px solid rgba(120, 86, 255, 0.5); color: #e7e9ea; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;" title="Start a multi-speaker meeting">
        <span>üéôÔ∏è</span> Meeting Mode
      </button>
      <button id="btn-mini-mode" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e7e9ea; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;" title="Open compact control panel">
        <span>üìå</span> Mini Mode
      </button>
      <div class="header-status">
        <div class="status-indicator" id="global-status"></div>
        <span id="global-status-text">Initializing...</span>
      </div>
    </div>
  </header>

  <div class="setup-container" id="setup-view">
    <div class="setup-card">
      <div class="setup-steps">
        <div class="setup-step active" id="step-1"></div>
        <div class="setup-step" id="step-2"></div>
        <div class="setup-step" id="step-3"></div>
      </div>

      <div id="screen-mic-test">
        <div class="setup-icon">üé§</div>
        <h1 class="setup-title">Test Your Microphone</h1>
        <p class="setup-description">Speak into your microphone to verify it's working. You should see the bars respond to your voice.</p>
        <div class="device-badge">
          <span>üìç</span>
          <span id="device-name">Detecting...</span>
        </div>
        <div class="mic-test-visual" id="mic-bars"></div>
        <button class="btn btn-primary" id="btn-continue" disabled>Continue</button>
        <button class="btn btn-secondary" id="btn-skip" style="margin-top: 10px;">Skip Setup</button>
      </div>

      <div id="screen-enrollment" class="hidden">
        <div class="setup-icon">üîä</div>
        <h1 class="setup-title">Record Your Voice</h1>
        <p class="setup-description">Speak clearly for about 10 seconds. Read something aloud or count numbers.</p>
        <div class="progress-ring-container">
          <svg class="progress-ring" width="140" height="140">
            <circle class="progress-ring-bg" cx="70" cy="70" r="60"/>
            <circle class="progress-ring-fg" id="enroll-progress-ring" cx="70" cy="70" r="60"/>
          </svg>
          <div class="progress-center">
            <span class="progress-percent" id="enroll-percent">0%</span>
            <span class="progress-label" id="enroll-label">Recording</span>
          </div>
        </div>
        <button class="btn btn-secondary" id="btn-cancel">Cancel</button>
      </div>

      <div id="screen-success" class="hidden">
        <div class="success-icon">‚úì</div>
        <h1 class="setup-title">Setup Complete</h1>
        <p class="setup-description">Your voice profile has been created. The filter will recognize your voice and mute unauthorized speakers.</p>
        <button class="btn btn-primary" id="btn-go-dashboard">Open Dashboard</button>
      </div>

      <div id="screen-error" class="hidden">
        <div class="setup-icon" style="background: rgba(244, 33, 46, 0.15);">‚ùå</div>
        <h1 class="setup-title">Setup Failed</h1>
        <div class="error-box">
          <div class="error-title">Error Details</div>
          <div class="error-message" id="error-text">An unknown error occurred.</div>
        </div>
        <button class="btn btn-primary" id="btn-retry">Try Again</button>
      </div>
    </div>
  </div>

  <div class="main-container hidden" id="dashboard-view">
    <div class="left-panel">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Speaker Verification</span>
          <span style="font-size: 11px; color: #71767b;">MFCC</span>
        </div>
        <div class="verification-panel">
          <div class="verification-ring">
            <div class="ring-bg"></div>
            <div class="ring-progress" id="verification-ring"></div>
            <div class="ring-content">
              <span class="ring-icon" id="verification-icon">üîá</span>
              <span class="ring-percentage" id="verification-percent">--</span>
              <span class="ring-label">confidence</span>
            </div>
          </div>
          <div class="verification-status pending" id="verification-status">Waiting</div>
          <div class="verification-subtitle" id="verification-subtitle">Start the filter to begin verification</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Audio Monitor</span>
        </div>
        <div class="card-body">
          <div class="audio-meters">
            <div class="meter">
              <div class="meter-label">Volume Level</div>
              <div class="meter-bar-container">
                <div class="meter-bar volume" id="volume-meter"></div>
              </div>
              <div class="meter-value" id="volume-value">0%</div>
            </div>
            <div class="meter">
              <div class="meter-label">Speech Probability</div>
              <div class="meter-bar-container">
                <div class="meter-bar vad" id="vad-meter"></div>
              </div>
              <div class="meter-value" id="vad-value">0%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <button class="btn btn-primary" id="btn-toggle-filter">Start Filter</button>
          <div class="quick-actions">
            <div class="quick-action" id="btn-re-enroll">
              <div class="quick-action-icon">üîÑ</div>
              <div class="quick-action-label">Re-enroll</div>
            </div>
            <div class="quick-action" id="btn-test-mic">
              <div class="quick-action-icon">üé§</div>
              <div class="quick-action-label">Test Mic</div>
            </div>
            <div class="quick-action" id="btn-exit">
              <div class="quick-action-icon">üö™</div>
              <div class="quick-action-label">Exit</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Devices</span>
        </div>
        <div class="card-body">
          <div class="device-selector">
            <div class="device-label"><span>üé§</span> Input Device</div>
            <select class="device-select" id="input-device"><option>Loading...</option></select>
          </div>
          <div class="device-selector">
            <div class="device-label"><span>üîä</span> Output Device</div>
            <select class="device-select" id="output-device"><option>Loading...</option></select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Settings</span>
        </div>
        <div class="card-body">
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Verification Threshold</div>
              <div class="setting-description">Higher = stricter</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="range" class="slider" id="verification-threshold" min="50" max="95" value="75">
              <span class="slider-value" id="threshold-value">75%</span>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">VAD Sensitivity</div>
              <div class="setting-description">Speech detection</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="range" class="slider" id="vad-threshold" min="1" max="100" value="10">
              <span class="slider-value" id="vad-value-setting">0.010</span>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Fail Open</div>
              <div class="setting-description">Allow when uncertain</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="fail-open">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Session Info</span>
        </div>
        <div class="card-body" style="padding: 10px 18px;">
          <div class="session-row">
            <span class="session-label">Speaker ID</span>
            <span class="session-value" id="session-speaker-id">--</span>
          </div>
          <div class="session-row">
            <span class="session-label">Verifications</span>
            <span class="session-value" id="session-verifications">0</span>
          </div>
          <div class="session-row">
            <span class="session-label">Blocks</span>
            <span class="session-value" id="session-blocks">0</span>
          </div>
          <div class="session-row">
            <span class="session-label">Last Check</span>
            <span class="session-value" id="session-last-check">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var ws = new WebSocket("ws://" + window.location.host);
    var setupView = document.getElementById("setup-view");
    var dashboardView = document.getElementById("dashboard-view");
    var screenMicTest = document.getElementById("screen-mic-test");
    var screenEnrollment = document.getElementById("screen-enrollment");
    var screenSuccess = document.getElementById("screen-success");
    var screenError = document.getElementById("screen-error");
    var step1 = document.getElementById("step-1");
    var step2 = document.getElementById("step-2");
    var step3 = document.getElementById("step-3");
    var globalStatus = document.getElementById("global-status");
    var globalStatusText = document.getElementById("global-status-text");
    var deviceName = document.getElementById("device-name");
    var btnContinue = document.getElementById("btn-continue");
    var btnSkip = document.getElementById("btn-skip");
    var btnCancel = document.getElementById("btn-cancel");
    var btnGoDashboard = document.getElementById("btn-go-dashboard");
    var btnRetry = document.getElementById("btn-retry");
    var btnToggleFilter = document.getElementById("btn-toggle-filter");
    var btnReEnroll = document.getElementById("btn-re-enroll");
    var btnTestMic = document.getElementById("btn-test-mic");
    var btnExit = document.getElementById("btn-exit");
    var verificationRing = document.getElementById("verification-ring");
    var verificationIcon = document.getElementById("verification-icon");
    var verificationPercent = document.getElementById("verification-percent");
    var verificationStatus = document.getElementById("verification-status");
    var verificationSubtitle = document.getElementById("verification-subtitle");
    var volumeMeter = document.getElementById("volume-meter");
    var volumeValue = document.getElementById("volume-value");
    var vadMeter = document.getElementById("vad-meter");
    var vadValue = document.getElementById("vad-value");
    var enrollProgressRing = document.getElementById("enroll-progress-ring");
    var enrollPercent = document.getElementById("enroll-percent");
    var enrollLabel = document.getElementById("enroll-label");
    var verificationThreshold = document.getElementById("verification-threshold");
    var thresholdValue = document.getElementById("threshold-value");
    var vadThreshold = document.getElementById("vad-threshold");
    var vadValueSetting = document.getElementById("vad-value-setting");
    var failOpenToggle = document.getElementById("fail-open");
    var sessionSpeakerId = document.getElementById("session-speaker-id");
    var sessionVerifications = document.getElementById("session-verifications");
    var sessionBlocks = document.getElementById("session-blocks");
    var sessionLastCheck = document.getElementById("session-last-check");

    var isFilterActive = false;
    var verificationCount = 0;
    var blockCount = 0;
    var micBarsCreated = false;

    function createMicBars() {
      if (micBarsCreated) return;
      var container = document.getElementById("mic-bars");
      for (var i = 0; i < 36; i++) {
        var bar = document.createElement("div");
        bar.className = "mic-bar";
        bar.id = "mic-bar-" + i;
        container.appendChild(bar);
      }
      micBarsCreated = true;
    }

    function updateMicBars(level) {
      for (var i = 0; i < 36; i++) {
        var bar = document.getElementById("mic-bar-" + i);
        if (!bar) continue;
        var randomFactor = 0.5 + Math.random() * 0.5;
        var barLevel = level * randomFactor;
        var height = Math.max(8, Math.min(44, barLevel * 100));
        bar.style.height = height + "px";
        bar.classList.toggle("active", barLevel > 0.05);
      }
    }

    function send(type, data) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: type, data: data || {} }));
      }
    }

    function showSetupScreen(screen) {
      screenMicTest.classList.add("hidden");
      screenEnrollment.classList.add("hidden");
      screenSuccess.classList.add("hidden");
      screenError.classList.add("hidden");
      step1.classList.remove("active", "completed");
      step2.classList.remove("active", "completed");
      step3.classList.remove("active", "completed");
      setupView.classList.remove("hidden");
      dashboardView.classList.add("hidden");
      if (screen === "mic-test") {
        screenMicTest.classList.remove("hidden");
        step1.classList.add("active");
        createMicBars();
      } else if (screen === "enrollment") {
        screenEnrollment.classList.remove("hidden");
        step1.classList.add("completed");
        step2.classList.add("active");
      } else if (screen === "success") {
        screenSuccess.classList.remove("hidden");
        step1.classList.add("completed");
        step2.classList.add("completed");
        step3.classList.add("active");
      } else if (screen === "error") {
        screenError.classList.remove("hidden");
      }
    }

    function showDashboard() {
      setupView.classList.add("hidden");
      dashboardView.classList.remove("hidden");
    }

    function updateVerificationUI(decision, confidence) {
      verificationRing.classList.remove("authorized", "unauthorized", "pending");
      verificationStatus.classList.remove("authorized", "unauthorized", "pending");
      var percent = Math.round(confidence * 100);
      verificationPercent.textContent = percent + "%";
      if (decision === "authorized") {
        verificationRing.classList.add("authorized");
        verificationStatus.classList.add("authorized");
        verificationIcon.textContent = "üîì";
        verificationStatus.textContent = "Authorized";
        verificationSubtitle.textContent = "Voice verified - audio passing through";
      } else if (decision === "unauthorized") {
        verificationRing.classList.add("unauthorized");
        verificationStatus.classList.add("unauthorized");
        verificationIcon.textContent = "üîí";
        verificationStatus.textContent = "Blocked";
        verificationSubtitle.textContent = "Unauthorized speaker - audio muted";
      } else {
        verificationRing.classList.add("pending");
        verificationStatus.classList.add("pending");
        verificationIcon.textContent = "üîÑ";
        verificationStatus.textContent = "Verifying";
        verificationSubtitle.textContent = "Analyzing voice pattern...";
      }
    }

    function updateGlobalStatus(status, text) {
      globalStatus.classList.remove("active", "warning", "error");
      globalStatus.classList.add(status);
      globalStatusText.textContent = text;
    }

    ws.onopen = function() {
      send("ready");
      updateGlobalStatus("active", "Connected");
    };

    ws.onclose = function() {
      updateGlobalStatus("error", "Disconnected");
    };

    ws.onmessage = function(event) {
      var msg = JSON.parse(event.data);
      var type = msg.type;
      var data = msg.data;
      if (type === "device-info") {
        deviceName.textContent = data.name;
      } else if (type === "volume-level") {
        var level = data;
        var percent = Math.round(level * 100);
        volumeMeter.style.width = percent + "%";
        volumeValue.textContent = percent + "%";
        updateMicBars(level);
        if (level > 0.1) {
          btnContinue.disabled = false;
        }
      } else if (type === "vad-level") {
        var vadPercent = Math.round(data * 100);
        vadMeter.style.width = vadPercent + "%";
        vadValue.textContent = vadPercent + "%";
      } else if (type === "enrollment-progress") {
        var progress = data;
        var enrollmentPercent = Math.round(progress.percentComplete);
        enrollPercent.textContent = enrollmentPercent + "%";
        enrollLabel.textContent = progress.isSpeech ? "Recording..." : "Speak now";
        var circumference = 2 * Math.PI * 60;
        var offset = circumference - (enrollmentPercent / 100) * circumference;
        enrollProgressRing.style.strokeDashoffset = offset;
      } else if (type === "enrollment-complete") {
        showSetupScreen("success");
      } else if (type === "enrollment-error") {
        document.getElementById("error-text").textContent = data.message;
        showSetupScreen("error");
      } else if (type === "has-profile") {
        showDashboard();
        if (data && data.speakerId) {
          sessionSpeakerId.textContent = data.speakerId.substring(0, 8) + "...";
        }
      } else if (type === "filter-started") {
        isFilterActive = true;
        btnToggleFilter.textContent = "Stop Filter";
        btnToggleFilter.classList.add("active");
        updateGlobalStatus("active", "Filter Active");
        updateVerificationUI("pending", 0);
      } else if (type === "filter-stopped") {
        isFilterActive = false;
        btnToggleFilter.textContent = "Start Filter";
        btnToggleFilter.classList.remove("active");
        updateGlobalStatus("warning", "Filter Inactive");
        verificationPercent.textContent = "--";
        verificationIcon.textContent = "üîá";
        verificationStatus.textContent = "Waiting";
        verificationStatus.classList.remove("authorized", "unauthorized", "pending");
        verificationSubtitle.textContent = "Start the filter to begin verification";
        verificationRing.classList.remove("authorized", "unauthorized", "pending");
      } else if (type === "filter-verification") {
        verificationCount++;
        sessionVerifications.textContent = verificationCount;
        sessionLastCheck.textContent = new Date().toLocaleTimeString();
        updateVerificationUI(data.decision, data.confidence);
        if (data.decision === "unauthorized") {
          blockCount++;
          sessionBlocks.textContent = blockCount;
        }
      } else if (type === "filter-muted") {
        updateVerificationUI("unauthorized", 0);
      } else if (type === "filter-unmuted") {
        updateVerificationUI("authorized", 1);
      } else if (type === "filter-error") {
        updateGlobalStatus("error", "Error");
        alert("Filter Error: " + data.message);
        isFilterActive = false;
        btnToggleFilter.textContent = "Start Filter";
        btnToggleFilter.classList.remove("active");
      } else if (type === "devices") {
        var inputSelect = document.getElementById("input-device");
        var outputSelect = document.getElementById("output-device");
        inputSelect.innerHTML = "";
        outputSelect.innerHTML = "";
        data.inputs.forEach(function(d) {
          var opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name;
          inputSelect.appendChild(opt);
        });
        data.outputs.forEach(function(d) {
          var opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name;
          outputSelect.appendChild(opt);
        });
      } else if (type === "settings") {
        verificationThreshold.value = data.verificationThreshold * 100;
        thresholdValue.textContent = Math.round(data.verificationThreshold * 100) + "%";
        vadThreshold.value = data.vadThreshold * 1000;
        vadValueSetting.textContent = data.vadThreshold.toFixed(3);
        failOpenToggle.checked = data.failOpen;
      }
    };

    btnContinue.onclick = function() { showSetupScreen("enrollment"); send("start-enrollment"); };
    btnSkip.onclick = function() { showDashboard(); };
    btnCancel.onclick = function() { send("cancel-enrollment"); showSetupScreen("mic-test"); };
    btnGoDashboard.onclick = function() { showDashboard(); };
    btnRetry.onclick = function() { btnContinue.disabled = true; showSetupScreen("mic-test"); send("restart-mic-test"); };
    btnToggleFilter.onclick = function() { if (isFilterActive) { send("stop-filter"); } else { send("start-filter"); } };
    btnReEnroll.onclick = function() { if (isFilterActive) { send("stop-filter"); } btnContinue.disabled = true; showSetupScreen("mic-test"); send("restart-mic-test"); };
    btnTestMic.onclick = function() { if (isFilterActive) { send("stop-filter"); } btnContinue.disabled = true; showSetupScreen("mic-test"); send("restart-mic-test"); };
    btnExit.onclick = function() { send("close-window"); window.close(); };
    verificationThreshold.oninput = function() { thresholdValue.textContent = verificationThreshold.value + "%"; send("update-settings", { verificationThreshold: verificationThreshold.value / 100 }); };
    vadThreshold.oninput = function() { var value = vadThreshold.value / 1000; vadValueSetting.textContent = value.toFixed(3); send("update-settings", { vadThreshold: value }); };
    failOpenToggle.onchange = function() { send("update-settings", { failOpen: failOpenToggle.checked }); };
    document.getElementById("input-device").onchange = function(e) { send("update-settings", { inputDeviceId: parseInt(e.target.value) }); };
    document.getElementById("output-device").onchange = function(e) { send("update-settings", { outputDeviceId: parseInt(e.target.value) }); };
    document.getElementById("btn-mini-mode").onclick = function() {
      window.open("/mini", "VoiceFilterMini", "width=225,height=460,resizable=yes,scrollbars=no,status=no,menubar=no,toolbar=no,location=no");
    };
    document.getElementById("btn-meeting-mode").onclick = function() {
      window.location.href = "/meeting";
    };

    createMicBars();
  </script>
</body>
</html>
