<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annix Voice Filter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f1419;
      color: #e7e9ea;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: linear-gradient(135deg, #1a1f26 0%, #141a21 100%);
      border-bottom: 1px solid #2f3336;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #1d9bf0 0%, #7856ff 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .logo-text { font-size: 18px; font-weight: 600; }
    .header-actions { display: flex; align-items: center; gap: 12px; }
    .header-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #e7e9ea;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .header-btn:hover { background: rgba(255,255,255,0.15); }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .welcome { text-align: center; margin-bottom: 48px; }
    .welcome-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, rgba(29, 155, 240, 0.15), rgba(120, 86, 255, 0.15));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 36px;
    }
    .welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
    .welcome-subtitle { font-size: 15px; color: #71767b; line-height: 1.5; max-width: 500px; margin: 0 auto; }
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      width: 100%;
    }
    .mode-card {
      background: #16181c;
      border: 1px solid #2f3336;
      border-radius: 16px;
      padding: 28px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .mode-card:hover {
      border-color: #1d9bf0;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    .mode-card.filter:hover { border-color: #00ba7c; }
    .mode-card.meeting:hover { border-color: #7856ff; }
    .mode-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 28px;
    }
    .mode-card.filter .mode-icon {
      background: linear-gradient(135deg, rgba(0, 186, 124, 0.2), rgba(29, 155, 240, 0.2));
    }
    .mode-card.meeting .mode-icon {
      background: linear-gradient(135deg, rgba(120, 86, 255, 0.2), rgba(249, 24, 128, 0.2));
    }
    .mode-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .mode-description { font-size: 13px; color: #71767b; line-height: 1.5; margin-bottom: 16px; }
    .mode-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .mode-feature {
      font-size: 11px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      color: #a0a4a8;
    }
    .mode-card.filter .mode-feature { color: #00ba7c; background: rgba(0, 186, 124, 0.1); }
    .mode-card.meeting .mode-feature { color: #7856ff; background: rgba(120, 86, 255, 0.1); }
    .mode-btn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-card.filter .mode-btn { background: #00ba7c; color: #fff; }
    .mode-card.filter .mode-btn:hover { background: #00a36c; }
    .mode-card.meeting .mode-btn { background: #7856ff; color: #fff; }
    .mode-card.meeting .mode-btn:hover { background: #6a4de0; }
    .footer-info {
      margin-top: 48px;
      text-align: center;
      font-size: 12px;
      color: #536471;
    }
    .footer-info a {
      color: #1d9bf0;
      text-decoration: none;
    }
    .footer-info a:hover { text-decoration: underline; }
    .profile-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #71767b;
    }
    .profile-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #71767b;
    }
    .profile-dot.enrolled { background: #00ba7c; }
    .account-menu {
      position: relative;
    }
    .account-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #e7e9ea;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .account-btn:hover { background: rgba(255,255,255,0.15); }
    .account-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1d9bf0 0%, #7856ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    .account-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: #16181c;
      border: 1px solid #2f3336;
      border-radius: 12px;
      min-width: 220px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
      z-index: 100;
      overflow: hidden;
    }
    .account-dropdown.visible { display: block; }
    .account-header {
      padding: 16px;
      border-bottom: 1px solid #2f3336;
    }
    .account-email {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .account-provider {
      font-size: 11px;
      color: #71767b;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .account-provider-badge {
      background: rgba(29, 155, 240, 0.2);
      color: #1d9bf0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      text-transform: capitalize;
    }
    .account-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      font-size: 13px;
      color: #e7e9ea;
      cursor: pointer;
      transition: background 0.2s;
    }
    .account-menu-item:hover { background: rgba(255,255,255,0.05); }
    .account-menu-item.danger { color: #f4212e; }
    .account-menu-item.danger:hover { background: rgba(244, 33, 46, 0.1); }
    .upcoming-section {
      width: 100%;
      margin-top: 40px;
      padding-top: 32px;
      border-top: 1px solid #2f3336;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-link {
      font-size: 13px;
      color: #1d9bf0;
      text-decoration: none;
    }
    .section-link:hover { text-decoration: underline; }
    .upcoming-events {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .upcoming-event {
      background: #16181c;
      border: 1px solid #2f3336;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upcoming-event:hover {
      border-color: #536471;
      background: #1c1f23;
    }
    .event-time-box {
      min-width: 60px;
      text-align: center;
      padding: 8px;
      background: #1c1f23;
      border-radius: 8px;
    }
    .event-time-day { font-size: 10px; color: #71767b; text-transform: uppercase; }
    .event-time-hour { font-size: 14px; font-weight: 600; margin-top: 2px; }
    .event-info { flex: 1; min-width: 0; }
    .event-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-meta { font-size: 12px; color: #71767b; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .event-provider-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: #2f3336;
      border-radius: 4px;
      text-transform: capitalize;
    }
    .event-join-btn {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      background: #1d9bf0;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .event-join-btn:hover { background: #1a8cd8; }
    .upcoming-empty {
      text-align: center;
      padding: 32px;
      color: #71767b;
      font-size: 14px;
    }
    .upcoming-empty-icon { font-size: 32px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">üéôÔ∏è</div>
      <span class="logo-text">Annix Voice Filter</span>
    </div>
    <div class="header-actions">
      <div class="profile-status">
        <div class="profile-dot" id="profile-dot"></div>
        <span id="profile-status-text">Checking profile...</span>
      </div>
      <button class="header-btn" id="btn-calendar" title="Connect your calendar">
        <span>üìÖ</span> Calendar
      </button>
      <button class="header-btn" id="btn-mini" title="Open compact control panel">
        <span>üìå</span> Mini Mode
      </button>
      <div class="account-menu">
        <button class="account-btn" id="account-btn">
          <div class="account-avatar" id="account-avatar">?</div>
          <span id="account-name">Account</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
        </button>
        <div class="account-dropdown" id="account-dropdown">
          <div class="account-header">
            <div class="account-email" id="account-email">Loading...</div>
            <div class="account-provider">
              Signed in via <span class="account-provider-badge" id="account-provider">-</span>
            </div>
          </div>
          <div class="account-menu-item" id="menu-settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Settings
          </div>
          <div class="account-menu-item" id="menu-calendar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Calendar Connections
          </div>
          <div class="account-menu-item danger" id="menu-logout">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sign Out
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="welcome">
      <div class="welcome-icon">üé§</div>
      <h1 class="welcome-title">Welcome to Voice Filter</h1>
      <p class="welcome-subtitle">Secure your audio with voice verification or capture multi-speaker meetings with automatic transcription.</p>
    </div>

    <div class="modes-grid">
      <div class="mode-card filter" id="card-filter">
        <div class="mode-icon">üîê</div>
        <h2 class="mode-title">Voice Filter</h2>
        <p class="mode-description">Protect your microphone by only allowing your voice through. Unauthorized speakers are automatically muted.</p>
        <div class="mode-features">
          <span class="mode-feature">Single Speaker</span>
          <span class="mode-feature">Real-time Verification</span>
          <span class="mode-feature">VB-Cable Output</span>
        </div>
        <button class="mode-btn">Open Voice Filter</button>
      </div>

      <div class="mode-card meeting" id="card-meeting">
        <div class="mode-icon">üë•</div>
        <h2 class="mode-title">Meeting Mode</h2>
        <p class="mode-description">Record meetings with automatic speaker identification and AI-powered transcription for meeting minutes.</p>
        <div class="mode-features">
          <span class="mode-feature">Multi-Speaker</span>
          <span class="mode-feature">Voice Enrollment</span>
          <span class="mode-feature">Live Transcript</span>
        </div>
        <button class="mode-btn">Start Meeting</button>
      </div>
    </div>

    <div class="upcoming-section" id="upcoming-section">
      <div class="section-header">
        <span class="section-title">üìÖ Upcoming Meetings</span>
        <a href="/calendar" class="section-link">View all ‚Üí</a>
      </div>
      <div class="upcoming-events" id="upcoming-events">
        <div class="upcoming-empty">
          <div class="upcoming-empty-icon">üìÖ</div>
          <div>Loading upcoming meetings...</div>
        </div>
      </div>
    </div>

    <div class="footer-info">
      <p>Need help? Check the <a href="#" id="link-docs">documentation</a> or <a href="#" id="link-settings">configure settings</a>.</p>
    </div>
  </div>

  <script>
    var ws = new WebSocket("ws://" + window.location.host);

    ws.onopen = function() {
      ws.send(JSON.stringify({ type: "ready", data: {} }));
    };

    ws.onmessage = function(event) {
      var msg = JSON.parse(event.data);
      if (msg.type === "has-profile") {
        document.getElementById("profile-dot").classList.add("enrolled");
        document.getElementById("profile-status-text").textContent = "Voice profile enrolled";
      }
    };

    document.getElementById("card-filter").onclick = function() {
      window.location.href = "/filter";
    };

    document.getElementById("card-meeting").onclick = function() {
      window.location.href = "/meeting";
    };

    document.getElementById("btn-calendar").onclick = function() {
      window.location.href = "/calendar";
    };

    document.getElementById("btn-mini").onclick = function() {
      window.open("/mini", "VoiceFilterMini", "width=225,height=460,resizable=yes,scrollbars=no,status=no,menubar=no,toolbar=no,location=no");
    };

    document.getElementById("link-settings").onclick = function(e) {
      e.preventDefault();
      window.location.href = "/filter";
    };

    document.getElementById("link-docs").onclick = function(e) {
      e.preventDefault();
      alert("Documentation coming soon!");
    };

    // Account dropdown
    var accountBtn = document.getElementById("account-btn");
    var accountDropdown = document.getElementById("account-dropdown");

    accountBtn.onclick = function(e) {
      e.stopPropagation();
      accountDropdown.classList.toggle("visible");
    };

    document.addEventListener("click", function() {
      accountDropdown.classList.remove("visible");
    });

    document.getElementById("menu-settings").onclick = function() {
      window.location.href = "/filter";
    };

    document.getElementById("menu-calendar").onclick = function() {
      window.location.href = "/calendar";
    };

    document.getElementById("menu-logout").onclick = function() {
      fetch("/api/logout", { method: "POST" })
        .then(function() {
          window.location.href = "/login";
        });
    };

    // Fetch user info
    fetch("/api/user")
      .then(function(res) { return res.json(); })
      .then(function(user) {
        var email = user.email || "Unknown";
        var initials = email.substring(0, 2).toUpperCase();
        document.getElementById("account-avatar").textContent = initials;
        document.getElementById("account-name").textContent = email.split("@")[0];
        document.getElementById("account-email").textContent = email;
        document.getElementById("account-provider").textContent = user.provider || "Email";
      })
      .catch(function() {
        document.getElementById("account-name").textContent = "Account";
      });

    // Fetch upcoming events
    function loadUpcomingEvents() {
      fetch("/api/calendar/upcoming?limit=5")
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var container = document.getElementById("upcoming-events");

          if (!data.events || data.events.length === 0) {
            container.innerHTML = '<div class="upcoming-empty">' +
              '<div class="upcoming-empty-icon">üìÖ</div>' +
              '<div>No upcoming meetings</div>' +
              '<div style="margin-top: 8px; font-size: 12px;"><a href="/calendar" style="color: #1d9bf0;">Connect your calendar</a> to see meetings here</div>' +
              '</div>';
            return;
          }

          var html = '';
          data.events.forEach(function(event) {
            var start = new Date(event.startTime);
            var now = new Date();
            var isToday = start.toDateString() === now.toDateString();
            var isTomorrow = start.toDateString() === new Date(now.getTime() + 86400000).toDateString();

            var dayStr = isToday ? 'Today' : (isTomorrow ? 'Tomorrow' : start.toLocaleDateString('en-US', { weekday: 'short' }));
            var timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            html += '<div class="upcoming-event" onclick="goToMeeting(\'' + (event.meetingUrl || '') + '\')">';
            html += '<div class="event-time-box">';
            html += '<div class="event-time-day">' + dayStr + '</div>';
            html += '<div class="event-time-hour">' + timeStr + '</div>';
            html += '</div>';
            html += '<div class="event-info">';
            html += '<div class="event-title">' + escapeHtml(event.title) + '</div>';
            html += '<div class="event-meta">';
            html += '<span class="event-provider-tag">' + event.provider + '</span>';
            if (event.location) {
              html += '<span>üìç ' + escapeHtml(event.location) + '</span>';
            }
            html += '</div>';
            html += '</div>';
            if (event.meetingUrl) {
              html += '<button class="event-join-btn" onclick="event.stopPropagation(); window.open(\'' + event.meetingUrl + '\', \'_blank\')">Join</button>';
            }
            html += '</div>';
          });

          container.innerHTML = html;
        })
        .catch(function(err) {
          console.error('Failed to load upcoming events:', err);
          document.getElementById("upcoming-events").innerHTML =
            '<div class="upcoming-empty"><div>Unable to load events</div></div>';
        });
    }

    function goToMeeting(url) {
      if (url) {
        window.open(url, '_blank');
      } else {
        window.location.href = '/meeting';
      }
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    loadUpcomingEvents();
  </script>
</body>
</html>
