#!/bin/bash

set -e

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SECRETS_PATTERNS_FILE="$ROOT_DIR/.secret-patterns"

echo "Running secret detection scan..."

# Get staged files (only text files, exclude certain paths)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v -E '(\.secret-patterns|pnpm-lock\.yaml|package-lock\.json|\.gitignore)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No files to scan."
    exit 0
fi

FOUND_SECRETS=0

# Check for patterns from the secrets pattern file
if [ -f "$SECRETS_PATTERNS_FILE" ]; then
    while IFS= read -r pattern || [ -n "$pattern" ]; do
        # Skip empty lines and comments
        [[ -z "$pattern" || "$pattern" =~ ^# ]] && continue

        for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
                # Search for the pattern in the staged version of the file
                if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
                    echo "ERROR: Potential secret found in $file"
                    echo "  Pattern: $pattern"
                    FOUND_SECRETS=1
                fi
            fi
        done
    done < "$SECRETS_PATTERNS_FILE"
fi

# Additional checks for common secret patterns
COMMON_PATTERNS=(
    # AWS
    'AKIA[0-9A-Z]{16}'
    'aws_secret_access_key\s*=\s*[A-Za-z0-9/+=]{40}'

    # Generic API keys (long alphanumeric strings after common key names)
    '(api[_-]?key|apikey|secret[_-]?key|password|passwd|pwd)\s*[=:]\s*["\x27][A-Za-z0-9!@#$%^&*()_+={}\[\]:;<>?,./\\|~-]{16,}["\x27]'

    # JWT secrets (specific format)
    'JWT_SECRET\s*=\s*["\x27]?[a-f0-9]{64}["\x27]?'

    # Private keys
    '-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----'

    # Fly.io tokens
    'FlyV1\s+fm2_'

    # Google API keys
    'AIza[0-9A-Za-z_-]{35}'

    # Generic secrets in env files committed to code
    'SMTP_PASS\s*=\s*["\x27]?[A-Za-z0-9]{8,}["\x27]?'
)

for pattern in "${COMMON_PATTERNS[@]}"; do
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
                echo "ERROR: Potential secret pattern found in $file"
                echo "  Pattern type: ${pattern:0:50}..."
                FOUND_SECRETS=1
            fi
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "=========================================="
    echo "COMMIT BLOCKED: Potential secrets detected"
    echo "=========================================="
    echo ""
    echo "If these are false positives, you can:"
    echo "  1. Add the pattern to .secret-patterns with a comment explaining why it's safe"
    echo "  2. Use 'git commit --no-verify' to bypass (NOT RECOMMENDED)"
    echo ""
    exit 1
fi

echo "Secret scan passed - no secrets detected."
