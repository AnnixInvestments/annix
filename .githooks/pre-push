#!/bin/bash

set -e

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

source "${ROOT_DIR}/node_modules/@annix/claude-swarm/timer.sh"

echo "Running pre-push checks..."

# Note: We check ALL files with biome to catch issues from any source

biome_check() {
  # Auto-fix any biome issues first
  pnpm biome check --write . 2>/dev/null || true

  # Check if there are any unfixed issues
  pnpm biome check .
}

run_tests() {
  rm -rf "$ROOT_DIR/annix-frontend/.next/dev"
  pnpm test:all
}

pull_rebase() {
  git fetch origin main 2>&1
  local behind ahead
  behind=$(git rev-list --count HEAD..origin/main)
  ahead=$(git rev-list --count origin/main..HEAD)

  if [ "$behind" -eq 0 ]; then
    echo "Already up to date with remote."
    return 0
  fi

  if [ "$ahead" -gt 0 ]; then
    echo "Branch has diverged (${ahead} ahead, ${behind} behind) â€” skipping auto-rebase."
    echo "If this is an intended force push, push will be rejected unless you use --force-with-lease."
    return 0
  fi

  echo "Integrating ${behind} new remote commit(s)..."
  if ! git rebase origin/main; then
    git rebase --abort 2>/dev/null || true
    echo ""
    echo "Rebase conflict: resolve the conflict below, then push again."
    return 1
  fi
}

cd "$ROOT_DIR"
timed_step "git pull --rebase" pull_rebase
timed_step "biome check" biome_check
timed_step "test suite" run_tests

cd "$ROOT_DIR/annix-backend"
timed_step "backend build" pnpm run build
timed_step "migrations" pnpm run migration:run

cd "$ROOT_DIR/annix-frontend"
timed_step "frontend build" pnpm run build

print_timing_summary

echo "Pre-push checks passed!"
