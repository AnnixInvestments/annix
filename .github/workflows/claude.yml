name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to implement"
        required: true
        type: string
      prompt:
        description: "Instructions for Claude (default: implement the issue)"
        required: false
        type: string
        default: ""

jobs:
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch issue details
        if: github.event_name == 'workflow_dispatch'
        id: issue
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ISSUE_JSON=$(gh issue view ${{ inputs.issue_number }} --repo ${{ github.repository }} --json title,body)
          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body')
          {
            echo "title<<ISSUE_EOF"
            echo "$TITLE"
            echo "ISSUE_EOF"
            echo "body<<BODY_EOF"
            echo "$BODY"
            echo "BODY_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code (event triggered)
        if: github.event_name != 'workflow_dispatch'
        id: claude-event
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PROJECT_TOKEN }}

      - name: Run Claude Code (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: claude-dispatch
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PROJECT_TOKEN }}
          show_full_output: true
          prompt: |
            You are operating autonomously. Do NOT ask questions or request clarification. Make all implementation decisions yourself based on the codebase, existing patterns, and the issue description. If something is ambiguous, pick the most reasonable approach and proceed.

            Read the CLAUDE.md and agents.md files for project conventions. Follow all existing patterns.

            Your task: implement the following GitHub issue. Create a feature branch, implement all changes, commit, push, and open a PR referencing issue #${{ inputs.issue_number }}.

            ${{ inputs.prompt }}

            ## Issue #${{ inputs.issue_number }}: ${{ steps.issue.outputs.title }}

            ${{ steps.issue.outputs.body }}
