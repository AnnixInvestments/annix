import { MigrationInterface, QueryRunner } from "typeorm";

export class AddAsmeB165AlloyPTRatings1772200000000 implements MigrationInterface {
  name = "AddAsmeB165AlloyPTRatings1772200000000";

  public async up(queryRunner: QueryRunner): Promise<void> {
    console.warn("Adding ASME B16.5 alloy material P-T ratings...");

    const b165Result = await queryRunner.query(
      `SELECT id FROM flange_standards WHERE code = 'ASME B16.5'`,
    );
    if (b165Result.length === 0) {
      console.warn("ASME B16.5 standard not found, skipping...");
      return;
    }
    const standardId = b165Result[0].id;

    const pressureClasses = await queryRunner.query(`
      SELECT id, designation FROM flange_pressure_classes
      WHERE "standardId" = ${standardId}
    `);

    const classMap: Record<string, number> = {};
    for (const pc of pressureClasses) {
      classMap[pc.designation] = pc.id;
    }

    const f11Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 17.7,
        "149": 15.8,
        "204": 15.8,
        "260": 15.8,
        "316": 14.9,
        "343": 14.6,
        "371": 13.7,
        "399": 11.2,
        "427": 8.4,
        "454": 5.6,
        "482": 3.4,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 48.5,
        "149": 46.4,
        "204": 44.7,
        "260": 43.2,
        "316": 41.6,
        "343": 40.9,
        "371": 38.4,
        "399": 31.7,
        "427": 23.7,
        "454": 15.8,
        "482": 9.5,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 64.7,
        "149": 61.9,
        "204": 59.6,
        "260": 57.6,
        "316": 55.5,
        "343": 54.5,
        "371": 51.2,
        "399": 42.3,
        "427": 31.6,
        "454": 21.1,
        "482": 12.6,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 97.0,
        "149": 92.8,
        "204": 89.4,
        "260": 86.3,
        "316": 83.2,
        "343": 81.8,
        "371": 76.8,
        "399": 63.4,
        "427": 47.4,
        "454": 31.6,
        "482": 19.0,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 145.5,
        "149": 139.2,
        "204": 134.1,
        "260": 129.5,
        "316": 124.8,
        "343": 122.7,
        "371": 115.2,
        "399": 95.1,
        "427": 71.1,
        "454": 47.4,
        "482": 28.4,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 242.5,
        "149": 232.0,
        "204": 223.5,
        "260": 215.8,
        "316": 208.0,
        "343": 204.5,
        "371": 192.0,
        "399": 158.5,
        "427": 118.5,
        "454": 79.0,
        "482": 47.4,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 404.2,
        "149": 386.7,
        "204": 372.5,
        "260": 359.6,
        "316": 346.7,
        "343": 340.8,
        "371": 320.0,
        "399": 264.2,
        "427": 197.5,
        "454": 131.7,
        "482": 79.0,
      },
    };

    const f22Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 18.3,
        "149": 17.2,
        "204": 17.2,
        "260": 17.2,
        "316": 16.4,
        "343": 16.0,
        "371": 15.3,
        "399": 13.7,
        "427": 11.5,
        "454": 9.0,
        "482": 6.3,
        "510": 4.2,
        "538": 2.6,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 49.4,
        "149": 47.8,
        "204": 46.4,
        "260": 45.2,
        "316": 44.0,
        "343": 43.2,
        "371": 41.3,
        "399": 37.1,
        "427": 31.1,
        "454": 24.3,
        "482": 17.0,
        "510": 11.3,
        "538": 7.0,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 65.9,
        "149": 63.7,
        "204": 61.9,
        "260": 60.2,
        "316": 58.6,
        "343": 57.6,
        "371": 55.1,
        "399": 49.4,
        "427": 41.5,
        "454": 32.4,
        "482": 22.7,
        "510": 15.1,
        "538": 9.4,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 98.8,
        "149": 95.6,
        "204": 92.8,
        "260": 90.4,
        "316": 87.9,
        "343": 86.4,
        "371": 82.6,
        "399": 74.1,
        "427": 62.2,
        "454": 48.6,
        "482": 34.0,
        "510": 22.7,
        "538": 14.0,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 148.2,
        "149": 143.3,
        "204": 139.2,
        "260": 135.5,
        "316": 131.9,
        "343": 129.6,
        "371": 123.9,
        "399": 111.2,
        "427": 93.3,
        "454": 72.9,
        "482": 51.0,
        "510": 34.0,
        "538": 21.0,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 247.0,
        "149": 238.9,
        "204": 232.0,
        "260": 225.9,
        "316": 219.8,
        "343": 216.0,
        "371": 206.6,
        "399": 185.3,
        "427": 155.5,
        "454": 121.5,
        "482": 85.0,
        "510": 56.7,
        "538": 35.0,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 411.7,
        "149": 398.2,
        "204": 386.7,
        "260": 376.5,
        "316": 366.4,
        "343": 360.1,
        "371": 344.3,
        "399": 308.9,
        "427": 259.2,
        "454": 202.5,
        "482": 141.7,
        "510": 94.4,
        "538": 58.3,
      },
    };

    const duplexF51Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 18.9,
        "149": 18.1,
        "204": 17.2,
        "260": 15.8,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 49.8,
        "149": 48.3,
        "204": 46.4,
        "260": 43.2,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 66.4,
        "149": 64.4,
        "204": 61.9,
        "260": 57.6,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 99.6,
        "149": 96.6,
        "204": 92.8,
        "260": 86.3,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 149.4,
        "149": 144.9,
        "204": 139.2,
        "260": 129.5,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 249.0,
        "149": 241.5,
        "204": 232.0,
        "260": 215.8,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 415.0,
        "149": 402.5,
        "204": 386.7,
        "260": 359.6,
      },
    };

    const superDuplexF55Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 19.2,
        "149": 18.6,
        "204": 17.9,
        "260": 16.8,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 50.4,
        "149": 49.3,
        "204": 47.8,
        "260": 45.2,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 67.2,
        "149": 65.7,
        "204": 63.7,
        "260": 60.2,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 100.8,
        "149": 98.5,
        "204": 95.6,
        "260": 90.4,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 151.2,
        "149": 147.8,
        "204": 143.3,
        "260": 135.5,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 252.0,
        "149": 246.3,
        "204": 238.9,
        "260": 225.9,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 420.0,
        "149": 410.6,
        "204": 398.2,
        "260": 376.5,
      },
    };

    const inconel625Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 18.9,
        "149": 18.1,
        "204": 17.2,
        "260": 16.4,
        "316": 15.5,
        "371": 14.6,
        "427": 13.4,
        "482": 11.9,
        "538": 10.1,
        "593": 8.1,
        "649": 6.1,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 49.8,
        "149": 48.3,
        "204": 46.4,
        "260": 44.5,
        "316": 42.5,
        "371": 40.2,
        "427": 37.1,
        "482": 32.9,
        "538": 28.1,
        "593": 22.5,
        "649": 17.0,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 66.4,
        "149": 64.4,
        "204": 61.9,
        "260": 59.3,
        "316": 56.7,
        "371": 53.6,
        "427": 49.4,
        "482": 43.9,
        "538": 37.5,
        "593": 30.0,
        "649": 22.7,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 99.6,
        "149": 96.6,
        "204": 92.8,
        "260": 89.0,
        "316": 85.0,
        "371": 80.4,
        "427": 74.1,
        "482": 65.8,
        "538": 56.2,
        "593": 45.0,
        "649": 34.0,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 149.4,
        "149": 144.9,
        "204": 139.2,
        "260": 133.5,
        "316": 127.5,
        "371": 120.6,
        "427": 111.2,
        "482": 98.7,
        "538": 84.3,
        "593": 67.5,
        "649": 51.0,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 249.0,
        "149": 241.5,
        "204": 232.0,
        "260": 222.5,
        "316": 212.5,
        "371": 201.0,
        "427": 185.3,
        "482": 164.5,
        "538": 140.5,
        "593": 112.5,
        "649": 85.0,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 415.0,
        "149": 402.5,
        "204": 386.7,
        "260": 370.8,
        "316": 354.2,
        "371": 335.0,
        "427": 308.9,
        "482": 274.2,
        "538": 234.2,
        "593": 187.5,
        "649": 141.7,
      },
    };

    const monel400Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 17.9,
        "149": 16.4,
        "204": 15.5,
        "260": 14.6,
        "316": 13.4,
        "371": 11.5,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 47.8,
        "149": 44.5,
        "204": 42.3,
        "260": 40.0,
        "316": 36.8,
        "371": 31.9,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 63.7,
        "149": 59.3,
        "204": 56.4,
        "260": 53.3,
        "316": 49.0,
        "371": 42.5,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 95.6,
        "149": 89.0,
        "204": 84.6,
        "260": 80.0,
        "316": 73.5,
        "371": 63.8,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 143.3,
        "149": 133.5,
        "204": 126.9,
        "260": 120.0,
        "316": 110.2,
        "371": 95.6,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 238.9,
        "149": 222.5,
        "204": 211.5,
        "260": 200.0,
        "316": 183.7,
        "371": 159.4,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 398.2,
        "149": 370.8,
        "204": 352.5,
        "260": 333.3,
        "316": 306.2,
        "371": 265.6,
      },
    };

    const hastelloyC276Data: Record<string, Record<number, number>> = {
      "150": {
        "-29": 19.6,
        "38": 19.6,
        "93": 19.2,
        "149": 18.6,
        "204": 17.9,
        "260": 17.0,
        "316": 16.0,
        "371": 14.9,
        "427": 13.4,
        "482": 11.5,
        "538": 9.3,
        "593": 7.0,
        "649": 5.0,
        "704": 3.3,
      },
      "300": {
        "-29": 51.1,
        "38": 51.1,
        "93": 50.4,
        "149": 49.3,
        "204": 47.8,
        "260": 45.8,
        "316": 43.4,
        "371": 40.5,
        "427": 36.8,
        "482": 31.9,
        "538": 25.8,
        "593": 19.4,
        "649": 13.9,
        "704": 9.2,
      },
      "400": {
        "-29": 68.1,
        "38": 68.1,
        "93": 67.2,
        "149": 65.7,
        "204": 63.7,
        "260": 61.1,
        "316": 57.9,
        "371": 54.0,
        "427": 49.0,
        "482": 42.5,
        "538": 34.4,
        "593": 25.9,
        "649": 18.5,
        "704": 12.3,
      },
      "600": {
        "-29": 102.1,
        "38": 102.1,
        "93": 100.8,
        "149": 98.5,
        "204": 95.6,
        "260": 91.7,
        "316": 86.9,
        "371": 81.0,
        "427": 73.5,
        "482": 63.8,
        "538": 51.6,
        "593": 38.9,
        "649": 27.7,
        "704": 18.4,
      },
      "900": {
        "-29": 153.2,
        "38": 153.2,
        "93": 151.2,
        "149": 147.8,
        "204": 143.3,
        "260": 137.5,
        "316": 130.3,
        "371": 121.5,
        "427": 110.2,
        "482": 95.6,
        "538": 77.4,
        "593": 58.3,
        "649": 41.6,
        "704": 27.6,
      },
      "1500": {
        "-29": 255.3,
        "38": 255.3,
        "93": 252.0,
        "149": 246.3,
        "204": 238.9,
        "260": 229.2,
        "316": 217.1,
        "371": 202.5,
        "427": 183.7,
        "482": 159.4,
        "538": 129.0,
        "593": 97.2,
        "649": 69.3,
        "704": 46.0,
      },
      "2500": {
        "-29": 425.5,
        "38": 425.5,
        "93": 420.0,
        "149": 410.6,
        "204": 398.2,
        "260": 381.9,
        "316": 361.9,
        "371": 337.5,
        "427": 306.2,
        "482": 265.6,
        "538": 215.0,
        "593": 162.0,
        "649": 115.5,
        "704": 76.7,
      },
    };

    await this.insertPTRatings(queryRunner, classMap, "Alloy Steel A182 F11 (Group 2.3)", f11Data);
    await this.insertPTRatings(queryRunner, classMap, "Alloy Steel A182 F22 (Group 2.4)", f22Data);
    await this.insertPTRatings(
      queryRunner,
      classMap,
      "Duplex Stainless Steel F51 (Group 3.2)",
      duplexF51Data,
    );
    await this.insertPTRatings(
      queryRunner,
      classMap,
      "Super Duplex Stainless Steel F55 (Group 3.3)",
      superDuplexF55Data,
    );
    await this.insertPTRatings(queryRunner, classMap, "Inconel 625 (Group 4.1)", inconel625Data);
    await this.insertPTRatings(queryRunner, classMap, "Monel 400 (Group 4.2)", monel400Data);
    await this.insertPTRatings(
      queryRunner,
      classMap,
      "Hastelloy C276 (Group 4.3)",
      hastelloyC276Data,
    );

    console.warn("ASME B16.5 alloy P-T ratings added successfully.");
  }

  private async insertPTRatings(
    queryRunner: QueryRunner,
    classMap: Record<string, number>,
    materialGroup: string,
    data: Record<string, Record<number, number>>,
  ): Promise<void> {
    for (const [designation, temps] of Object.entries(data)) {
      const classId = classMap[designation];
      if (!classId) continue;

      for (const [tempStr, pressureBar] of Object.entries(temps)) {
        const temp = parseFloat(tempStr);
        await queryRunner.query(
          `
          INSERT INTO flange_pt_ratings (pressure_class_id, material_group, temperature_celsius, max_pressure_bar)
          VALUES ($1, $2, $3, $4)
          ON CONFLICT (pressure_class_id, material_group, temperature_celsius)
          DO UPDATE SET max_pressure_bar = $4
        `,
          [classId, materialGroup, temp, pressureBar],
        );
      }
    }
    console.warn(`Added ASME B16.5 P-T ratings for ${materialGroup}`);
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    const b165Result = await queryRunner.query(
      `SELECT id FROM flange_standards WHERE code = 'ASME B16.5'`,
    );
    if (b165Result.length === 0) return;
    const standardId = b165Result[0].id;

    const materials = [
      "Alloy Steel A182 F11 (Group 2.3)",
      "Alloy Steel A182 F22 (Group 2.4)",
      "Duplex Stainless Steel F51 (Group 3.2)",
      "Super Duplex Stainless Steel F55 (Group 3.3)",
      "Inconel 625 (Group 4.1)",
      "Monel 400 (Group 4.2)",
      "Hastelloy C276 (Group 4.3)",
    ];

    for (const material of materials) {
      await queryRunner.query(
        `
        DELETE FROM flange_pt_ratings
        WHERE pressure_class_id IN (SELECT id FROM flange_pressure_classes WHERE "standardId" = $1)
        AND material_group = $2
      `,
        [standardId, material],
      );
    }
  }
}
