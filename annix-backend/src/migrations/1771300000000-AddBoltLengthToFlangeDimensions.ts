import { MigrationInterface, QueryRunner } from "typeorm";

export class AddBoltLengthToFlangeDimensions1771300000000 implements MigrationInterface {
  name = "AddBoltLengthToFlangeDimensions1771300000000";

  public async up(queryRunner: QueryRunner): Promise<void> {
    console.warn("Adding bolt_length_mm column to flange_dimensions...");

    const columnExists = await queryRunner.query(`
      SELECT column_name FROM information_schema.columns
      WHERE table_name = 'flange_dimensions' AND column_name = 'bolt_length_mm'
    `);

    if (columnExists.length === 0) {
      await queryRunner.query(`
        ALTER TABLE flange_dimensions
        ADD COLUMN bolt_length_mm float NULL
      `);
      console.warn("Added bolt_length_mm column");
    }

    console.warn("Updating bolt lengths for SABS 1123 flanges...");

    const sabs1123Result = await queryRunner.query(
      `SELECT id FROM flange_standards WHERE code = 'SABS 1123'`,
    );
    if (sabs1123Result.length === 0) {
      console.warn("SABS 1123 standard not found, skipping bolt length updates...");
      return;
    }
    const sabs1123Id = sabs1123Result[0].id;

    const getNominalId = async (nominalMm: number) => {
      const result = await queryRunner.query(`
        SELECT id FROM nominal_outside_diameters
        WHERE nominal_diameter_mm = ${nominalMm}
        LIMIT 1
      `);
      return result[0]?.id;
    };

    const getTypeId = async (code: string) => {
      const result = await queryRunner.query(`SELECT id FROM flange_types WHERE code = '${code}'`);
      return result[0]?.id;
    };

    const getPressureClassId = async (designation: string) => {
      const result = await queryRunner.query(`
        SELECT id FROM flange_pressure_classes
        WHERE designation = '${designation}' AND "standardId" = ${sabs1123Id}
      `);
      return result[0]?.id;
    };

    // Bolt length data for ALL SABS 1123 flanges
    // Format: [NB, type, pressureClass, boltLength]
    const boltLengthData: Array<[number, string, number, number]> = [
      // T600
      [15, "/2", 600, 35],
      [15, "/3", 600, 30],
      [15, "/1", 600, 25],
      [15, "/8", 600, 30],
      [20, "/2", 600, 40],
      [20, "/3", 600, 30],
      [20, "/1", 600, 25],
      [20, "/8", 600, 35],
      [25, "/2", 600, 40],
      [25, "/3", 600, 30],
      [25, "/1", 600, 25],
      [25, "/8", 600, 35],
      [32, "/2", 600, 45],
      [32, "/3", 600, 35],
      [32, "/1", 600, 30],
      [32, "/8", 600, 40],
      [40, "/2", 600, 45],
      [40, "/3", 600, 35],
      [40, "/1", 600, 30],
      [40, "/8", 600, 40],
      [50, "/2", 600, 50],
      [50, "/3", 600, 40],
      [50, "/1", 600, 35],
      [50, "/8", 600, 45],
      [65, "/2", 600, 55],
      [65, "/3", 600, 45],
      [65, "/1", 600, 40],
      [65, "/8", 600, 50],
      [80, "/2", 600, 55],
      [80, "/3", 600, 45],
      [80, "/1", 600, 40],
      [80, "/8", 600, 50],
      [100, "/2", 600, 60],
      [100, "/3", 600, 50],
      [100, "/1", 600, 45],
      [100, "/8", 600, 55],
      [150, "/2", 600, 70],
      [150, "/3", 600, 55],
      [150, "/1", 600, 50],
      [150, "/8", 600, 60],
      [200, "/2", 600, 80],
      [200, "/3", 600, 60],
      [200, "/1", 600, 55],
      [200, "/8", 600, 70],
      [250, "/2", 600, 90],
      [250, "/3", 600, 70],
      [250, "/1", 600, 65],
      [250, "/8", 600, 80],
      [300, "/2", 600, 100],
      [300, "/3", 600, 75],
      [300, "/1", 600, 70],
      [300, "/8", 600, 90],
      [350, "/2", 600, 110],
      [350, "/3", 600, 80],
      [350, "/1", 600, 75],
      [350, "/8", 600, 100],
      [400, "/2", 600, 120],
      [400, "/3", 600, 90],
      [400, "/1", 600, 85],
      [400, "/8", 600, 110],
      [450, "/2", 600, 130],
      [450, "/3", 600, 95],
      [450, "/1", 600, 90],
      [450, "/8", 600, 115],
      [500, "/2", 600, 140],
      [500, "/3", 600, 100],
      [500, "/1", 600, 95],
      [500, "/8", 600, 125],
      [600, "/2", 600, 160],
      [600, "/3", 600, 115],
      [600, "/1", 600, 110],
      [600, "/8", 600, 145],

      // T1000
      [15, "/2", 1000, 45],
      [15, "/3", 1000, 35],
      [15, "/1", 1000, 30],
      [15, "/8", 1000, 40],
      [20, "/2", 1000, 50],
      [20, "/3", 1000, 35],
      [20, "/1", 1000, 30],
      [20, "/8", 1000, 45],
      [25, "/2", 1000, 50],
      [25, "/3", 1000, 35],
      [25, "/1", 1000, 30],
      [25, "/8", 1000, 45],
      [32, "/2", 1000, 55],
      [32, "/3", 1000, 40],
      [32, "/1", 1000, 35],
      [32, "/8", 1000, 50],
      [40, "/2", 1000, 55],
      [40, "/3", 1000, 40],
      [40, "/1", 1000, 35],
      [40, "/8", 1000, 50],
      [50, "/2", 1000, 60],
      [50, "/3", 1000, 45],
      [50, "/1", 1000, 40],
      [50, "/8", 1000, 55],
      [65, "/2", 1000, 65],
      [65, "/3", 1000, 50],
      [65, "/1", 1000, 45],
      [65, "/8", 1000, 60],
      [80, "/2", 1000, 65],
      [80, "/3", 1000, 50],
      [80, "/1", 1000, 45],
      [80, "/8", 1000, 60],
      [100, "/2", 1000, 75],
      [100, "/3", 1000, 55],
      [100, "/1", 1000, 50],
      [100, "/8", 1000, 70],
      [150, "/2", 1000, 90],
      [150, "/3", 1000, 65],
      [150, "/1", 1000, 60],
      [150, "/8", 1000, 80],
      [200, "/2", 1000, 105],
      [200, "/3", 1000, 75],
      [200, "/1", 1000, 70],
      [200, "/8", 1000, 95],
      [250, "/2", 1000, 120],
      [250, "/3", 1000, 85],
      [250, "/1", 1000, 80],
      [250, "/8", 1000, 110],
      [300, "/2", 1000, 135],
      [300, "/3", 1000, 95],
      [300, "/1", 1000, 90],
      [300, "/8", 1000, 125],
      [350, "/2", 1000, 145],
      [350, "/3", 1000, 105],
      [350, "/1", 1000, 100],
      [350, "/8", 1000, 135],
      [400, "/2", 1000, 160],
      [400, "/3", 1000, 115],
      [400, "/1", 1000, 110],
      [400, "/8", 1000, 150],
      [450, "/2", 1000, 175],
      [450, "/3", 1000, 125],
      [450, "/1", 1000, 120],
      [450, "/8", 1000, 165],
      [500, "/2", 1000, 190],
      [500, "/3", 1000, 140],
      [500, "/1", 1000, 135],
      [500, "/8", 1000, 180],
      [600, "/2", 1000, 220],
      [600, "/3", 1000, 160],
      [600, "/1", 1000, 155],
      [600, "/8", 1000, 210],

      // T1600
      [15, "/2", 1600, 45],
      [15, "/3", 1600, 35],
      [15, "/1", 1600, 30],
      [15, "/8", 1600, 45],
      [20, "/2", 1600, 50],
      [20, "/3", 1600, 35],
      [20, "/1", 1600, 30],
      [20, "/8", 1600, 50],
      [25, "/2", 1600, 50],
      [25, "/3", 1600, 35],
      [25, "/1", 1600, 30],
      [25, "/8", 1600, 50],
      [32, "/2", 1600, 55],
      [32, "/3", 1600, 40],
      [32, "/1", 1600, 35],
      [32, "/8", 1600, 55],
      [40, "/2", 1600, 55],
      [40, "/3", 1600, 40],
      [40, "/1", 1600, 35],
      [40, "/8", 1600, 55],
      [50, "/2", 1600, 65],
      [50, "/3", 1600, 50],
      [50, "/1", 1600, 45],
      [50, "/8", 1600, 65],
      [65, "/2", 1600, 70],
      [65, "/3", 1600, 55],
      [65, "/1", 1600, 50],
      [65, "/8", 1600, 70],
      [80, "/2", 1600, 75],
      [80, "/3", 1600, 55],
      [80, "/1", 1600, 50],
      [80, "/8", 1600, 70],
      [100, "/2", 1600, 85],
      [100, "/3", 1600, 65],
      [100, "/1", 1600, 60],
      [100, "/8", 1600, 85],
      [150, "/2", 1600, 105],
      [150, "/3", 1600, 80],
      [150, "/1", 1600, 75],
      [150, "/8", 1600, 100],
      [200, "/2", 1600, 125],
      [200, "/3", 1600, 95],
      [200, "/1", 1600, 90],
      [200, "/8", 1600, 120],
      [250, "/2", 1600, 150],
      [250, "/3", 1600, 110],
      [250, "/1", 1600, 105],
      [250, "/8", 1600, 145],
      [300, "/2", 1600, 175],
      [300, "/3", 1600, 130],
      [300, "/1", 1600, 125],
      [300, "/8", 1600, 170],
      [350, "/2", 1600, 195],
      [350, "/3", 1600, 145],
      [350, "/1", 1600, 140],
      [350, "/8", 1600, 190],
      [400, "/2", 1600, 220],
      [400, "/3", 1600, 165],
      [400, "/1", 1600, 160],
      [400, "/8", 1600, 215],
      [450, "/2", 1600, 245],
      [450, "/3", 1600, 180],
      [450, "/1", 1600, 175],
      [450, "/8", 1600, 240],
      [500, "/2", 1600, 270],
      [500, "/3", 1600, 200],
      [500, "/1", 1600, 195],
      [500, "/8", 1600, 265],
      [600, "/2", 1600, 320],
      [600, "/3", 1600, 235],
      [600, "/1", 1600, 230],
      [600, "/8", 1600, 315],

      // T2500
      [15, "/2", 2500, 50],
      [15, "/3", 2500, 45],
      [15, "/8", 2500, 50],
      [20, "/2", 2500, 55],
      [20, "/3", 2500, 45],
      [20, "/8", 2500, 55],
      [25, "/2", 2500, 55],
      [25, "/3", 2500, 45],
      [25, "/8", 2500, 55],
      [32, "/2", 2500, 65],
      [32, "/3", 2500, 50],
      [32, "/8", 2500, 65],
      [40, "/2", 2500, 65],
      [40, "/3", 2500, 50],
      [40, "/8", 2500, 65],
      [50, "/2", 2500, 75],
      [50, "/3", 2500, 55],
      [50, "/8", 2500, 75],
      [65, "/2", 2500, 85],
      [65, "/3", 2500, 65],
      [65, "/8", 2500, 85],
      [80, "/2", 2500, 90],
      [80, "/3", 2500, 70],
      [80, "/8", 2500, 90],
      [100, "/2", 2500, 105],
      [100, "/3", 2500, 80],
      [100, "/8", 2500, 105],
      [150, "/2", 2500, 135],
      [150, "/3", 2500, 100],
      [150, "/8", 2500, 130],
      [200, "/2", 2500, 170],
      [200, "/3", 2500, 125],
      [200, "/8", 2500, 165],
      [250, "/2", 2500, 205],
      [250, "/3", 2500, 150],
      [250, "/8", 2500, 200],
      [300, "/2", 2500, 240],
      [300, "/3", 2500, 175],
      [300, "/8", 2500, 235],
      [350, "/2", 2500, 275],
      [350, "/3", 2500, 200],
      [350, "/8", 2500, 270],
      [400, "/2", 2500, 310],
      [400, "/3", 2500, 225],
      [400, "/8", 2500, 305],
      [450, "/2", 2500, 345],
      [450, "/3", 2500, 250],
      [450, "/8", 2500, 340],
      [500, "/2", 2500, 380],
      [500, "/3", 2500, 280],
      [500, "/8", 2500, 375],
      [600, "/2", 2500, 450],
      [600, "/3", 2500, 330],
      [600, "/8", 2500, 445],

      // T4000
      [15, "/2", 4000, 55],
      [15, "/3", 4000, 45],
      [15, "/8", 4000, 55],
      [20, "/2", 4000, 60],
      [20, "/3", 4000, 45],
      [20, "/8", 4000, 60],
      [25, "/2", 4000, 65],
      [25, "/3", 4000, 50],
      [25, "/8", 4000, 65],
      [32, "/2", 4000, 75],
      [32, "/3", 4000, 55],
      [32, "/8", 4000, 75],
      [40, "/2", 4000, 75],
      [40, "/3", 4000, 55],
      [40, "/8", 4000, 75],
      [50, "/2", 4000, 85],
      [50, "/3", 4000, 60],
      [50, "/8", 4000, 85],
      [65, "/2", 4000, 95],
      [65, "/3", 4000, 70],
      [65, "/8", 4000, 95],
      [80, "/2", 4000, 95],
      [80, "/3", 4000, 70],
      [80, "/8", 4000, 95],
      [100, "/2", 4000, 110],
      [100, "/3", 4000, 80],
      [100, "/8", 4000, 110],
      [150, "/2", 4000, 140],
      [150, "/3", 4000, 100],
      [150, "/8", 4000, 140],
      [200, "/2", 4000, 165],
      [200, "/3", 4000, 115],
      [200, "/8", 4000, 165],
      [250, "/2", 4000, 185],
      [250, "/3", 4000, 130],
      [250, "/8", 4000, 185],
      [300, "/2", 4000, 215],
      [300, "/3", 4000, 150],
      [300, "/8", 4000, 215],
      [350, "/2", 4000, 235],
      [350, "/3", 4000, 165],
      [350, "/1", 4000, 155],
      [350, "/7", 4000, 180],
      [350, "/8", 4000, 235],
      [400, "/2", 4000, 250],
      [400, "/3", 4000, 180],
      [400, "/1", 4000, 170],
      [400, "/7", 4000, 195],
      [400, "/8", 4000, 250],
      [450, "/2", 4000, 265],
      [450, "/3", 4000, 190],
      [450, "/1", 4000, 180],
      [450, "/7", 4000, 205],
      [450, "/8", 4000, 265],
      [500, "/2", 4000, 285],
      [500, "/3", 4000, 205],
      [500, "/1", 4000, 195],
      [500, "/7", 4000, 220],
      [500, "/8", 4000, 285],
      [600, "/2", 4000, 335],
      [600, "/3", 4000, 240],
      [600, "/1", 4000, 230],
      [600, "/7", 4000, 260],
      [600, "/8", 4000, 335],
    ];

    for (const [nb, typeCode, pressureValue, boltLength] of boltLengthData) {
      const nominalId = await getNominalId(nb);
      if (!nominalId) continue;

      const typeId = await getTypeId(typeCode);
      const designation = `${pressureValue}${typeCode}`;
      const pressureClassId = await getPressureClassId(designation);
      if (!pressureClassId) continue;

      const whereClause = typeId
        ? `WHERE "nominalOutsideDiameterId" = ${nominalId} AND "standardId" = ${sabs1123Id} AND "pressureClassId" = ${pressureClassId} AND "flangeTypeId" = ${typeId}`
        : `WHERE "nominalOutsideDiameterId" = ${nominalId} AND "standardId" = ${sabs1123Id} AND "pressureClassId" = ${pressureClassId}`;

      await queryRunner.query(`
        UPDATE flange_dimensions
        SET bolt_length_mm = ${boltLength}
        ${whereClause}
      `);
    }

    console.warn("Bolt lengths updated successfully.");
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`
      ALTER TABLE flange_dimensions DROP COLUMN IF EXISTS bolt_length_mm
    `);
  }
}
