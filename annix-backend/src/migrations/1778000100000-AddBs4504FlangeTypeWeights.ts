import { MigrationInterface, QueryRunner } from "typeorm";

export class AddBs4504FlangeTypeWeights1778000100000 implements MigrationInterface {
  public async up(queryRunner: QueryRunner): Promise<void> {
    const bs4504Id = await this.flangeStandardId(queryRunner, "BS 4504");

    const pressureClasses = [
      "PN6",
      "PN10",
      "PN16",
      "PN25",
      "PN40",
      "PN64",
      "Class 150",
      "Class 300",
      "Class 600",
    ];

    for (const pc of pressureClasses) {
      const weldNeckWeights = this.bs4504WeldNeckWeights()[pc];
      const plateWeights = this.bs4504PlateWeights()[pc];

      if (weldNeckWeights) {
        const values = Object.entries(weldNeckWeights)
          .map(([nb, weight]) => `(${bs4504Id}, '${pc}', '/2', ${nb}, ${weight})`)
          .join(", ");
        if (values) {
          await queryRunner.query(`
            INSERT INTO flange_type_weights (flange_standard_id, pressure_class, flange_type_code, nominal_bore_mm, weight_kg)
            VALUES ${values}
          `);
        }
      }

      if (plateWeights) {
        const values = Object.entries(plateWeights)
          .map(([nb, weight]) => `(${bs4504Id}, '${pc}', '/3', ${nb}, ${weight})`)
          .join(", ");
        if (values) {
          await queryRunner.query(`
            INSERT INTO flange_type_weights (flange_standard_id, pressure_class, flange_type_code, nominal_bore_mm, weight_kg)
            VALUES ${values}
          `);
        }
      }
    }
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    const bs4504Id = await this.flangeStandardId(queryRunner, "BS 4504");
    await queryRunner.query(
      `DELETE FROM flange_type_weights WHERE flange_standard_id = ${bs4504Id}`,
    );
  }

  private async flangeStandardId(queryRunner: QueryRunner, code: string): Promise<string> {
    const result = await queryRunner.query("SELECT id FROM flange_standards WHERE code = $1", [
      code,
    ]);
    return result.length === 0 ? "NULL" : result[0].id.toString();
  }

  private bs4504WeldNeckWeights(): Record<string, Record<number, number>> {
    return {
      PN6: {
        15: 0.8,
        20: 0.9,
        25: 1.0,
        32: 1.6,
        40: 1.8,
        50: 2.4,
        65: 2.6,
        80: 3.2,
        100: 3.6,
        125: 5.2,
        150: 6.0,
        200: 9.2,
        250: 12.4,
        300: 14.4,
        350: 19.6,
        400: 23.6,
        450: 31.6,
        500: 40.0,
        600: 56.0,
        700: 72.0,
        750: 80.0,
        800: 92.0,
        900: 116.0,
        1000: 148.0,
      },
      PN10: {
        15: 1.0,
        20: 1.0,
        25: 1.0,
        32: 2.0,
        40: 2.0,
        50: 3.0,
        65: 3.0,
        80: 4.0,
        100: 4.5,
        125: 6.5,
        150: 7.5,
        200: 11.5,
        250: 15.5,
        300: 18.0,
        350: 24.5,
        400: 29.5,
        450: 36.0,
        500: 39.5,
        600: 56.0,
        700: 65.0,
        750: 76.0,
        800: 87.0,
        900: 106.0,
        1000: 123.0,
        1200: 180.0,
      },
      PN16: {
        15: 1.0,
        20: 1.0,
        25: 1.0,
        32: 2.0,
        40: 2.0,
        50: 3.0,
        65: 3.0,
        80: 4.0,
        100: 4.5,
        125: 6.5,
        150: 7.5,
        200: 11.0,
        250: 16.5,
        300: 22.0,
        350: 32.0,
        400: 40.0,
        450: 54.5,
        500: 74.0,
        600: 116.5,
        700: 87.0,
        750: 98.0,
        800: 111.0,
        900: 129.0,
        1000: 169.0,
        1200: 250.0,
      },
      PN25: {
        15: 1.0,
        20: 1.0,
        25: 1.0,
        32: 2.0,
        40: 2.0,
        50: 3.0,
        65: 3.5,
        80: 4.5,
        100: 5.5,
        125: 7.5,
        150: 9.5,
        200: 16.0,
        250: 25.0,
        300: 35.0,
        350: 50.0,
        400: 68.0,
        450: 80.0,
        500: 100.0,
        600: 160.0,
        700: 110.0,
        750: 130.0,
        800: 150.0,
        900: 180.0,
        1000: 220.0,
      },
      PN40: {
        15: 1.0,
        20: 1.0,
        25: 1.0,
        32: 2.0,
        40: 2.0,
        50: 3.0,
        65: 4.0,
        80: 5.0,
        100: 6.5,
        125: 9.0,
        150: 11.5,
        200: 21.0,
        250: 34.0,
        300: 47.5,
        350: 69.0,
        400: 98.0,
        450: 106.0,
        500: 130.0,
        600: 211.0,
      },
      PN64: {
        15: 1.2,
        20: 1.4,
        25: 1.6,
        32: 2.5,
        40: 3.0,
        50: 4.0,
        65: 5.5,
        80: 7.0,
        100: 9.0,
        125: 12.5,
        150: 16.5,
        200: 30.0,
        250: 50.0,
        300: 75.0,
        350: 110.0,
        400: 155.0,
        450: 200.0,
        500: 260.0,
        600: 400.0,
      },
      "Class 150": {
        15: 0.8,
        20: 1.1,
        25: 1.3,
        32: 1.9,
        40: 2.3,
        50: 3.2,
        65: 4.8,
        80: 5.8,
        100: 8.5,
        125: 11.7,
        150: 16.0,
        200: 25.5,
        250: 40.5,
        300: 58.5,
        350: 80.0,
        400: 106.5,
        450: 138.5,
        500: 175.5,
        600: 255.5,
      },
      "Class 300": {
        15: 1.2,
        20: 1.9,
        25: 2.3,
        32: 3.2,
        40: 4.5,
        50: 5.0,
        65: 7.0,
        80: 9.2,
        100: 16.5,
        125: 20.3,
        150: 27.5,
        200: 40.5,
        250: 56.5,
        300: 80.5,
        350: 115.5,
        400: 147.0,
        450: 177.5,
        500: 221.0,
        600: 343.5,
      },
      "Class 600": {
        15: 1.8,
        20: 2.6,
        25: 3.3,
        32: 4.7,
        40: 6.5,
        50: 8.8,
        65: 13.0,
        80: 17.5,
        100: 26.0,
        125: 37.5,
        150: 52.5,
        200: 91.0,
        250: 152.0,
        300: 228.0,
        350: 327.5,
        400: 450.0,
        450: 595.5,
        500: 770.0,
        600: 1170.0,
      },
    };
  }

  private bs4504PlateWeights(): Record<string, Record<number, number>> {
    return {
      PN6: {
        15: 0.35,
        20: 0.5,
        25: 0.6,
        32: 0.95,
        40: 1.1,
        50: 1.2,
        65: 1.5,
        80: 2.4,
        100: 2.65,
        125: 3.5,
        150: 3.85,
        200: 5.55,
        250: 7.2,
        300: 9.6,
        350: 13.5,
        400: 16.0,
        450: 19.4,
        500: 21.2,
        600: 28.0,
        700: 42.3,
        750: 50.0,
        800: 57.5,
        900: 76.5,
        1000: 100.0,
      },
      PN10: {
        15: 0.54,
        20: 0.76,
        25: 0.9,
        32: 1.47,
        40: 1.68,
        50: 2.21,
        65: 2.55,
        80: 2.9,
        100: 3.55,
        125: 4.37,
        150: 5.77,
        200: 7.5,
        250: 9.5,
        300: 11.0,
        350: 16.5,
        400: 22.2,
        450: 27.5,
        500: 32.8,
        600: 44.5,
        700: 67.0,
        750: 79.5,
        800: 94.5,
        900: 126.0,
        1000: 155.0,
        1200: 248.0,
      },
      PN16: {
        15: 0.67,
        20: 0.93,
        25: 1.11,
        32: 1.82,
        40: 2.08,
        50: 2.72,
        65: 3.31,
        80: 3.59,
        100: 4.38,
        125: 5.39,
        150: 7.12,
        200: 9.71,
        250: 14.16,
        300: 18.93,
        350: 28.12,
        400: 35.75,
        450: 46.0,
        500: 63.83,
        600: 101.29,
        700: 111.1,
        750: 125.0,
        800: 158.56,
        900: 192.24,
        1000: 269.55,
        1200: 400.0,
      },
      PN25: {
        15: 0.67,
        20: 0.93,
        25: 1.11,
        32: 1.82,
        40: 2.08,
        50: 2.72,
        65: 3.31,
        80: 3.9,
        100: 5.0,
        125: 6.5,
        150: 8.5,
        200: 13.5,
        250: 20.0,
        300: 28.0,
        350: 42.0,
        400: 55.0,
        450: 70.0,
        500: 90.0,
        600: 145.0,
      },
      PN40: {
        15: 0.8,
        20: 1.1,
        25: 1.3,
        32: 2.2,
        40: 2.5,
        50: 3.3,
        65: 4.0,
        80: 4.8,
        100: 6.0,
        125: 8.0,
        150: 10.5,
        200: 18.0,
        250: 28.0,
        300: 40.0,
        350: 60.0,
        400: 85.0,
        450: 95.0,
        500: 115.0,
        600: 185.0,
      },
      PN64: {
        15: 1.0,
        20: 1.4,
        25: 1.6,
        32: 2.8,
        40: 3.2,
        50: 4.2,
        65: 5.2,
        80: 6.2,
        100: 8.0,
        125: 11.0,
        150: 14.5,
        200: 25.0,
        250: 40.0,
        300: 60.0,
        350: 90.0,
        400: 130.0,
        450: 165.0,
        500: 210.0,
        600: 340.0,
      },
      "Class 150": {
        15: 0.5,
        20: 0.9,
        25: 0.9,
        32: 1.4,
        40: 1.4,
        50: 2.3,
        65: 3.6,
        80: 4.1,
        100: 5.9,
        125: 6.8,
        150: 8.6,
        200: 13.5,
        250: 19.4,
        300: 28.8,
        350: 40.5,
        400: 47.7,
        450: 58.5,
        500: 74.3,
        600: 99.0,
      },
      "Class 300": {
        15: 0.9,
        20: 1.4,
        25: 1.4,
        32: 2.0,
        40: 2.9,
        50: 3.2,
        65: 4.5,
        80: 5.9,
        100: 10.6,
        125: 13.0,
        150: 17.6,
        200: 26.1,
        250: 36.5,
        300: 51.8,
        350: 74.3,
        400: 94.5,
        450: 113.9,
        500: 141.8,
        600: 220.5,
      },
      "Class 600": {
        15: 1.4,
        20: 2.0,
        25: 2.3,
        32: 3.2,
        40: 4.5,
        50: 5.0,
        65: 7.3,
        80: 9.5,
        100: 16.8,
        125: 21.0,
        150: 28.5,
        200: 45.0,
        250: 65.0,
        300: 95.0,
        350: 140.0,
        400: 185.0,
        450: 235.0,
        500: 300.0,
        600: 480.0,
      },
    };
  }
}
